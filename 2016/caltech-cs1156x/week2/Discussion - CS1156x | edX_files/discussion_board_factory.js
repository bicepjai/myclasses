(function(){this.DiscussionUtil=function(){function e(){}e.wmdEditors={},e.getTemplate=function(e){return $("script#"+e).html()},e.setUser=function(e){this.user=e},e.getUser=function(){return this.user},e.loadRoles=function(e){this.roleIds=e},e.isStaff=function(e){var t;return _.isUndefined(e)&&(e=this.user?this.user.id:void 0),t=_.union(this.roleIds.Moderator,this.roleIds.Administrator),_.include(t,parseInt(e))},e.isTA=function(e){var t;return _.isUndefined(e)&&(e=this.user?this.user.id:void 0),t=_.union(this.roleIds["Community TA"]),_.include(t,parseInt(e))},e.isPrivilegedUser=function(e){return this.isStaff(e)||this.isTA(e)},e.bulkUpdateContentInfo=function(e){var t,s,i;i=[];for(t in e)e.hasOwnProperty(t)&&(s=e[t],i.push(Content.getContent(t).updateInfo(s)));return i},e.generateDiscussionLink=function(e,t,s){return $("<a>").addClass("discussion-link").attr("href","#").addClass(e).text(t).click(function(){return s(this)})},e.urlFor=function(e,t,s){return{follow_discussion:"/courses/"+$$course_id+"/discussion/"+t+"/follow",unfollow_discussion:"/courses/"+$$course_id+"/discussion/"+t+"/unfollow",create_thread:"/courses/"+$$course_id+"/discussion/"+t+"/threads/create",update_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/update",create_comment:"/courses/"+$$course_id+"/discussion/threads/"+t+"/reply",delete_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/delete",flagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/flagAbuse",unFlagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unFlagAbuse",flagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/flagAbuse",unFlagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/unFlagAbuse",upvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/upvote",downvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/downvote",pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/pin",un_pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unpin",undo_vote_for_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unvote",follow_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/follow",unfollow_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/unfollow",update_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/update",endorse_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/endorse",create_sub_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/reply",delete_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/delete",upvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/upvote",downvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/downvote",undo_vote_for_comment:"/courses/"+$$course_id+"/discussion/comments/"+t+"/unvote",upload:"/courses/"+$$course_id+"/discussion/upload",users:"/courses/"+$$course_id+"/discussion/users",search:"/courses/"+$$course_id+"/discussion/forum/search",retrieve_discussion:"/courses/"+$$course_id+"/discussion/forum/"+t+"/inline",retrieve_single_thread:"/courses/"+$$course_id+"/discussion/forum/"+t+"/threads/"+s,openclose_thread:"/courses/"+$$course_id+"/discussion/threads/"+t+"/close",user_profile:"/courses/"+$$course_id+"/discussion/forum/users/"+t,followed_threads:"/courses/"+$$course_id+"/discussion/forum/users/"+t+"/followed",threads:"/courses/"+$$course_id+"/discussion/forum",enable_notifications:"/notification_prefs/enable/",disable_notifications:"/notification_prefs/disable/",notifications_status:"/notification_prefs/status/"}[e]},e.ignoreEnterKey=function(e){return 13===e.which?e.preventDefault():void 0},e.activateOnSpace=function(e,t){return 32===e.which?(e.preventDefault(),t(e)):void 0},e.makeFocusTrap=function(e){return e.keydown(function(e){return 9===e.which?e.preventDefault():void 0})},e.showLoadingIndicator=function(e,t){var s=edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<div class='loading-animation' tabindex='0'><span class='sr'>"),gettext("Loading content"),edx.HtmlUtils.HTML("</span></div>")),i=$(s.toString());e.after(i),this.$_loading=i,t&&(this.makeFocusTrap(this.$_loading),this.$_loading.focus())},e.hideLoadingIndicator=function(){return this.$_loading.remove()},e.discussionAlert=function(e,t){var s,i,o=$("#alert-popup").html()||"";0===$("#discussion-alert").length&&(s=$(edx.HtmlUtils.template(o)({}).toString()),this.makeFocusTrap(s.find("button")),i=$("<a href='#discussion-alert' id='discussion-alert-trigger'/>").css("display","none"),i.leanModal({closeButton:"#discussion-alert .dismiss",overlay:1,top:200}),$("body").append(s).append(i)),$("#discussion-alert header h2").text(e),$("#discussion-alert p").text(t),$("#discussion-alert-trigger").click(),$("#discussion-alert button").focus()},e.safeAjax=function(e){var t,s,i,o=this;return t=e.$elem,t&&t.prop("disabled")?(s=$.Deferred(),s.reject(),s.promise()):(e.url=URI(e.url).addSearch({ajax:1}),e.error||(e.error=function(){o.discussionAlert(gettext("Sorry"),gettext("We had some trouble processing your request. Please ensure you have copied any unsaved work and then reload the page."))}),t&&t.prop("disabled",!0),e.$loading&&(e.loadingCallback?e.loadingCallback.apply(e.$loading):o.showLoadingIndicator(e.$loading,e.takeFocus)),i=$.ajax(e).always(function(){return t&&t.prop("disabled",!1),e.$loading?e.loadedCallback?e.loadedCallback.apply(e.$loading):o.hideLoadingIndicator():void 0}))},e.updateWithUndo=function(e,t,s,i,o){var r,n=this;return i&&(s.error=function(){return n.discussionAlert(gettext("Sorry"),i)}),r=_.pick(e.attributes,_.keys(t)),e.set(t),"function"==typeof o&&o(),this.safeAjax(s).fail(function(){return e.set(r)})},e.bindLocalEvents=function(e,t){var s,i,o,r,n,a;a=[];for(i in t)t.hasOwnProperty(i)&&(o=t[i],n=i.split(" "),s=n[0],r=n[1],a.push(e(r).unbind(s)[s](o)));return a},e.formErrorHandler=function(e){return function(t){var s,i,o,r;if(s=function(e,t){return edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<li>"),edx.HtmlUtils.template($("#new-post-alert-template").html())({message:e,alertId:t}),edx.HtmlUtils.HTML("</li>"))},e.empty().show(),400===t.status){if(i=JSON.parse(t.responseText),i.errors)for(o=0;o<i.errors.length;o++)r=s(i.errors[o],o),edx.HtmlUtils.append(e,r)}else r=s("We had some trouble processing your request. Please try again.",0),edx.HtmlUtils.append(e,r);$('div[role="alert"]',e).first().focus()}},e.clearFormErrors=function(e){return e.empty()},e.postMathJaxProcessor=function(e){var t,s;return s=/^\$([^\$]*)\$/g,t=/^\$\$([^\$]*)\$\$/g,this.processEachMathAndCode(e,function(e,i){return"display"===i?e.replace(t,function(e,t){return"\\["+t+"\\]"}):"inline"===i?e.replace(s,function(e,t){return"\\("+t+"\\)"}):e})},e.makeWmdEditor=function(e,t,s){var i,o,r,n,a,d,l;return r=t("."+s),d=r.data("placeholder"),n=r.data("id"),i="-"+s+"-"+n,a=this.urlFor("upload"),l=function(e){return function(t){return e.postMathJaxProcessor(edx.HtmlUtils.HTML(t)).toString()}},o=Markdown.makeWmdEditor(r,i,a,l(this)),this.wmdEditors[""+s+"-"+n]=o,d&&r.find("#wmd-input"+i).attr("placeholder",d),o},e.getWmdEditor=function(e,t,s){var i,o;return i=t("."+s),o=i.attr("data-id"),this.wmdEditors[""+s+"-"+o]},e.getWmdInput=function(e,t,s){var i,o;return i=t("."+s),o=i.attr("data-id"),t("#wmd-input-"+s+"-"+o)},e.getWmdContent=function(e,t,s){return this.getWmdInput(e,t,s).val()},e.setWmdContent=function(e,t,s,i){return this.getWmdInput(e,t,s).val(i),this.getWmdEditor(e,t,s).refreshPreview()};var t=/^([^\$]*?)\$\$([^\$]*?)\$\$(.*)$/m,s=/^([^\$]*?)\$([^\$]+?)\$(.*)$/m,i="@@ESCAPED_D@@",o="@@ESCAPED_B@@";return e.processEachMathAndCode=function(e,r){var n,a,d,l;for(a={},d="",n=edx.HtmlUtils.setHtml($("<div>"),edx.HtmlUtils.ensureHtml(e)),n.find("code").each(function(e,t){return a[e]=$(t).html(),$(t).text(e)}),l=n.html(),l=l.replace(/\\\$/g,i);;)if(s.test(l))l=l.replace(s,function(e,t,s,i){return d+=t+r("$"+s+"$","inline"),i});else{if(!t.test(l)){d+=l;break}l=l.replace(t,function(e,t,s,i){return d+=t+r("$$"+s+"$$","display"),i})}return l=d,l=l.replace(new RegExp(i,"g"),"\\$"),l=l.replace(/\\\\\\\\/g,o),l=l.replace(/\\begin\{([a-z]*\*?)\}([\s\S]*?)\\end\{\1\}/gim,function(e,t,s){return r("\\begin{"+t+"}"+s+("\\end{"+t+"}"))}),l=l.replace(new RegExp(o,"g"),"\\\\\\\\"),n=edx.HtmlUtils.setHtml($("<div>"),edx.HtmlUtils.HTML(l)),n.find("code").each(function(e,t){edx.HtmlUtils.setHtml($(t),edx.HtmlUtils.HTML(r(a[e],"code")))}),edx.HtmlUtils.HTML(n.html())},e.unescapeHighlightTag=function(e){return edx.HtmlUtils.HTML(e.toString().replace(/\&lt\;highlight\&gt\;/g,"<span class='search-highlight'>").replace(/\&lt\;\/highlight\&gt\;/g,"</span>"))},e.stripHighlight=function(e){return e.replace(/\&(amp\;)?lt\;highlight\&(amp\;)?gt\;/g,"").replace(/\&(amp\;)?lt\;\/highlight\&(amp\;)?gt\;/g,"")},e.stripLatexHighlight=function(e){return this.processEachMathAndCode(e,this.stripHighlight)},e.markdownWithHighlight=function(e){var t;e=e.replace(/^\&gt\;/gm,">"),t=Markdown.getMathCompatibleConverter();var s=edx.HtmlUtils.HTML(t.makeHtml(e));return this.unescapeHighlightTag(this.stripLatexHighlight(s))},e.abbreviateString=function(e,t){if(e.length<t)return e;for(;t<e.length&&" "!==e[t];)t++;return e.substr(0,t)+gettext("…")},e.convertMath=function(e){edx.HtmlUtils.setHtml(e,this.postMathJaxProcessor(this.markdownWithHighlight(e.text()))),this.typesetMathJax(e)},e.typesetMathJax=function(e){"undefined"!=typeof MathJax&&null!==MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub,e[0]])},e.abbreviateHTML=function(e,t){var s,i,o;o=edx.HtmlUtils.HTML(jQuery.truncate(e.toString(),{length:t,noBreaks:!0,ellipsis:gettext("…")})),s=$(edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<div>"),o,edx.HtmlUtils.HTML("</div>")).toString()),i=s.find("img:not(:first)"),i.length>0&&edx.HtmlUtils.append(s,edx.HtmlUtils.interpolateHtml(edx.HtmlUtils.HTML("<p><em>{text}</em></p>"),{text:gettext("Some images in this post have been omitted")}));var r=edx.HtmlUtils.interpolateHtml(edx.HtmlUtils.HTML("<em>{text}</em>"),{text:gettext("image omitted")});return i.after(edx.HtmlUtils.ensureHtml(r).toString()).remove(),s.html()},e.getPaginationParams=function(e,t,s){var i,o,r,n;return i=2,r=Math.max(e-i,1),o=Math.min(e+i,t),n=function(e){return{number:e,url:s(e)}},{page:e,lowPages:_.range(r,e).map(n),highPages:_.range(e+1,o+1).map(n),previous:e>1?n(e-1):null,next:t>e?n(e+1):null,leftdots:r>2,rightdots:t-1>o,first:r>1?n(1):null,last:t>o?n(t):null}},e}.call(this)}).call(window),RequireJS.define("common/js/discussion/utils",function(){}),function(){var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var o in s)e.call(s,o)&&(t[o]=s[o]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadListView=function(e){function s(){var e=this;return this.updateEmailNotifications=function(){return s.prototype.updateEmailNotifications.apply(e,arguments)},this.retrieveFollowed=function(){return s.prototype.retrieveFollowed.apply(e,arguments)},this.chooseCohort=function(){return s.prototype.chooseCohort.apply(e,arguments)},this.chooseFilter=function(){return s.prototype.chooseFilter.apply(e,arguments)},this.keyboardBinding=function(){return s.prototype.keyboardBinding.apply(e,arguments)},this.filterTopics=function(){return s.prototype.filterTopics.apply(e,arguments)},this.toggleBrowseMenu=function(){return s.prototype.toggleBrowseMenu.apply(e,arguments)},this.hideBrowseMenu=function(){return s.prototype.hideBrowseMenu.apply(e,arguments)},this.showBrowseMenu=function(){return s.prototype.showBrowseMenu.apply(e,arguments)},this.isBrowseMenuVisible=function(){return s.prototype.isBrowseMenuVisible.apply(e,arguments)},this.threadRemoved=function(){return s.prototype.threadRemoved.apply(e,arguments)},this.threadSelected=function(){return s.prototype.threadSelected.apply(e,arguments)},this.renderThread=function(){return s.prototype.renderThread.apply(e,arguments)},this.loadMorePages=function(){return s.prototype.loadMorePages.apply(e,arguments)},this.showMetadataAccordingToSort=function(){return s.prototype.showMetadataAccordingToSort.apply(e,arguments)},this.renderThreads=function(){return s.prototype.renderThreads.apply(e,arguments)},this.updateSidebar=function(){return s.prototype.updateSidebar.apply(e,arguments)},this.addAndSelectThread=function(){return s.prototype.addAndSelectThread.apply(e,arguments)},this.reloadDisplayedCollection=function(){return s.prototype.reloadDisplayedCollection.apply(e,arguments)},this.clearSearchAlerts=function(){return s.prototype.clearSearchAlerts.apply(e,arguments)},this.removeSearchAlert=function(){return s.prototype.removeSearchAlert.apply(e,arguments)},this.addSearchAlert=function(){return s.prototype.addSearchAlert.apply(e,arguments)},s.__super__.constructor.apply(this,arguments)}return t(s,e),s.prototype.events={"keypress .forum-nav-browse-filter-input":function(e){return DiscussionUtil.ignoreEnterKey(e)},"keyup .forum-nav-browse-filter-input":"filterTopics","keydown .forum-nav-browse-filter-input":"keyboardBinding","click .forum-nav-browse-menu-wrapper":"ignoreClick","click .forum-nav-browse-title":"selectTopicHandler","change .forum-nav-sort-control":"sortThreads","click .forum-nav-thread-link":"threadSelected","click .forum-nav-load-more-link":"loadMorePages","change .forum-nav-filter-main-control":"chooseFilter","change .forum-nav-filter-cohort-control":"chooseCohort"},s.prototype.initialize=function(e){var t=this;this.courseSettings=e.courseSettings,this.displayedCollection=new Discussion(this.collection.models,{pages:this.collection.pages}),this.collection.on("change",this.reloadDisplayedCollection),this.discussionIds="",this.collection.on("reset",function(e){var s;return s=$(".current-board").html(),t.displayedCollection.current_page=e.current_page,t.displayedCollection.pages=e.pages,t.displayedCollection.reset(e.models)}),this.collection.on("add",this.addAndSelectThread),this.collection.on("thread:remove",this.threadRemoved),this.sidebar_padding=10,this.boardName=null,this.current_search="",this.mode="all",this.keyCodes={enter:13,escape:27,up:38,down:40},this.filterInputReset(),this.selectedTopic=$(".forum-nav-browse-menu-item:visible .forum-nav-browse-title.is-focused"),this.searchAlertCollection=new Backbone.Collection([],{model:Backbone.Model}),this.searchAlertCollection.on("add",function(e){var s;return s=edx.HtmlUtils.template($("#search-alert-template").html())({messageHtml:e.attributes.message,cid:e.cid,css_class:e.attributes.css_class}),edx.HtmlUtils.append(t.$(".search-alerts"),s),t.$("#search-alert-"+e.cid+" .dismiss").bind("click",e,function(e){return t.removeSearchAlert(e.data.cid)})}),this.searchAlertCollection.on("remove",function(e){return t.$("#search-alert-"+e.cid).remove()}),this.searchAlertCollection.on("reset",function(){return t.$(".search-alerts").empty()}),this.template=edx.HtmlUtils.template($("#thread-list-template").html()),this.homeTemplate=edx.HtmlUtils.template($("#discussion-home-template").html()),this.threadListItemTemplate=edx.HtmlUtils.template($("#thread-list-item-template").html())},s.prototype.addSearchAlert=function(e,t){var s;return s=new Backbone.Model({message:e,css_class:t||""}),this.searchAlertCollection.add(s),s},s.prototype.removeSearchAlert=function(e){return this.searchAlertCollection.remove(e)},s.prototype.clearSearchAlerts=function(){return this.searchAlertCollection.reset()},s.prototype.reloadDisplayedCollection=function(e){var t,s,i,o;return this.clearSearchAlerts(),o=e.get("id"),s=this.renderThread(e),i=this.$(".forum-nav-thread[data-id="+o+"]"),t=0!==i.has(".forum-nav-thread-link.is-active").length,i.replaceWith(s),this.showMetadataAccordingToSort(),t?this.setActiveThread(o):void 0},s.prototype.addAndSelectThread=function(e){var t=e.get("commentable_id"),s=this;return this.retrieveDiscussion(t,function(){return s.trigger("thread:created",e.get("id"))})},s.prototype.updateSidebar=function(){var e,t,s,i,o,r,n,a,d,l,u,c,h;d=$(window).scrollTop(),h=$(window).height(),s=$(".discussion-column"),r=s[0]?s.offset().top:void 0,o=r+s.outerHeight(),l=$(".forum-nav"),d>r-this.sidebar_padding?l.css("top",d-r+this.sidebar_padding):l.css("top","0"),u=h-Math.max(r-d,this.sidebar_padding),c=d+h,i=o+this.sidebar_padding,e=Math.max(c-i,0),u=u-this.sidebar_padding-e,u=Math.min(u+1,s.outerHeight()),l.css("height",u),n=this.$(".forum-nav-header").outerHeight(),a=this.$(".forum-nav-refine-bar").outerHeight(),t=this.$(".forum-nav-browse-filter").outerHeight(),this.$(".forum-nav-thread-list").css("height",u-n-a-2+"px"),this.$(".forum-nav-browse-menu").css("height",u-n-t-2+"px")},s.prototype.ignoreClick=function(e){return e.stopPropagation()},s.prototype.render=function(){var e=this;return this.timer=0,this.$el.empty(),edx.HtmlUtils.append(this.$el,this.template({isCohorted:this.courseSettings.get("is_cohorted"),isPrivilegedUser:DiscussionUtil.isPrivilegedUser()})),this.$(".forum-nav-sort-control option").removeProp("selected"),this.$(".forum-nav-sort-control option[value="+this.collection.sort_preference+"]").prop("selected",!0),$(window).bind("load scroll resize",this.updateSidebar),this.displayedCollection.on("reset",this.renderThreads),this.displayedCollection.on("thread:remove",this.renderThreads),this.displayedCollection.on("change:commentable_id",function(){return"commentables"===e.mode?e.retrieveDiscussions(e.discussionIds.split(",")):void 0}),this.renderThreads(),this.showBrowseMenu(!0),this},s.prototype.renderThreads=function(){var e,t,s,i;for(this.$(".forum-nav-thread-list").empty(),s=0,i=this.displayedCollection.models.length;i>s;s++)t=this.displayedCollection.models[s],e=this.renderThread(t),this.$(".forum-nav-thread-list").append(e);this.showMetadataAccordingToSort(),this.renderMorePages(),this.updateSidebar(),this.trigger("threads:rendered")},s.prototype.showMetadataAccordingToSort=function(){var e=this.$(".forum-nav-thread-votes-count"),t=this.$(".forum-nav-thread-unread-comments-count"),s=this.$(".forum-nav-thread-comments-count");switch(e.hide(),s.hide(),t.hide(),this.$(".forum-nav-sort-control").val()){case"votes":e.show();break;default:t.show(),s.show()}},s.prototype.renderMorePages=function(){this.displayedCollection.hasMorePages()&&edx.HtmlUtils.append(this.$(".forum-nav-thread-list"),edx.HtmlUtils.template($("#nav-load-more-link").html())({}))},s.prototype.getLoadingContent=function(e){return edx.HtmlUtils.template($("#nav-loading-template").html())({srText:e})},s.prototype.loadMorePages=function(e){var t,s,i,o,r,n,a=this;switch(e&&e.preventDefault(),i=this.$(".forum-nav-load-more"),i.empty(),edx.HtmlUtils.append(i,this.getLoadingContent(gettext("Loading more threads"))),o=i.find(".forum-nav-loading"),DiscussionUtil.makeFocusTrap(o),o.focus(),r={filter:this.filter},this.mode){case"search":r.search_text=this.current_search,this.group_id&&(r.group_id=this.group_id);break;case"followed":r.user_id=window.user.id;break;case"commentables":r.commentable_ids=this.discussionIds,this.group_id&&(r.group_id=this.group_id);break;case"all":this.group_id&&(r.group_id=this.group_id)}return n=this.collection.last(),s=n?n.get("id"):void 0,s?this.once("threads:rendered",function(){var e=".forum-nav-thread[data-id='"+s+"'] + .forum-nav-thread .forum-nav-thread-link";return $(e).focus()}):this.once("threads:rendered",function(){var e=$(".forum-nav-thread-link").first();return e?e.focus():void 0}),t=function(){a.renderThreads(),DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more threads. Please try again."))},this.collection.retrieveAnotherPage(this.mode,r,{sort_key:this.$(".forum-nav-sort-control").val()},t)},s.prototype.renderThread=function(e){var t=e.get("comments_count"),s=e.get("unread_comments_count"),i=!e.get("read")&&s===t,o=_.extend({neverRead:i,threadUrl:e.urlFor("retrieve")},e.toJSON());return $(this.threadListItemTemplate(o).toString())},s.prototype.threadSelected=function(e){var t;return t=$(e.target).closest(".forum-nav-thread").attr("data-id"),this.setActiveThread(t),this.trigger("thread:selected",t),!1},s.prototype.threadRemoved=function(e){this.trigger("thread:removed",e)},s.prototype.setActiveThread=function(e){var t;this.$(".forum-nav-thread-link").find(".sr").remove(),this.$(".forum-nav-thread[data-id!='"+e+"'] .forum-nav-thread-link").removeClass("is-active"),t=edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML('<span class="sr">'),edx.HtmlUtils.ensureHtml(gettext("Current conversation")),edx.HtmlUtils.HTML("</span>")).toString(),this.$(".forum-nav-thread[data-id='"+e+"'] .forum-nav-thread-link").addClass("is-active").find(".forum-nav-thread-wrapper-1").prepend(t)},s.prototype.goHome=function(){var e,t;t=$(this.homeTemplate().toString()),$(".forum-content").empty().append(t),$(".forum-nav-thread-list a").removeClass("is-active").find(".sr").remove(),$("input.email-setting").bind("click",this.updateEmailNotifications),e=DiscussionUtil.urlFor("notifications_status",window.user.get("id")),DiscussionUtil.safeAjax({url:e,type:"GET",success:function(e){$("input.email-setting").prop("checked",e.status)}})},s.prototype.isBrowseMenuVisible=function(){return this.$(".forum-nav-browse-menu-wrapper").is(":visible")},s.prototype.showBrowseMenu=function(e){return this.isBrowseMenuVisible()?void 0:(this.$(".forum-nav-browse-menu-wrapper").show(),this.$(".forum-nav-thread-list-wrapper").hide(),e||($(".forum-nav-browse-filter-input").focus(),this.filterInputReset()),$("body").bind("click",this.hideBrowseMenu),this.updateSidebar())},s.prototype.hideBrowseMenu=function(){var e=this.$(".forum-nav-browse-title.is-focused");return this.isBrowseMenuVisible()?(e.removeClass("is-focused"),this.$(".forum-nav-browse-menu-wrapper").hide(),this.$(".forum-nav-thread-list-wrapper").show(),"undefined"!==this.selectedTopicId&&this.$(".forum-nav-browse-filter-input").attr("aria-activedescendant",this.selectedTopicId),$("body").unbind("click",this.hideBrowseMenu),this.updateSidebar()):void 0},s.prototype.toggleBrowseMenu=function(e){var t=$(".forum-nav-browse-filter-input").val();return e.preventDefault(),e.stopPropagation(),this.isBrowseMenuVisible()?this.hideBrowseMenu():(""!==t&&this.filterTopics(t),this.showBrowseMenu())},s.prototype.getPathText=function(e){var t,s;return t=e.parents(".forum-nav-browse-menu-item").andSelf(),s=t.children(".forum-nav-browse-title").map(function(e,t){return $(t).text()}).get(),s.join(" / ")},s.prototype.getBreadcrumbText=function(e){var t=e.parents(".forum-nav-browse-submenu"),s=[],i=$(".forum-nav-browse-title",e).first().text().trim();return t.each(function(e,t){s.push($(t).siblings(".forum-nav-browse-title").first().text().trim())}),"All Discussions"!==i&&s.push(i),s},s.prototype.selectOption=function(e){var t,s;this.selectedTopic.length>0&&this.selectedTopic.removeClass("is-focused"),e&&(e.addClass("is-focused"),t=e.parent().attr("id"),s=e.text(),this.selectedTopic=e,this.selectedTopicId=t,$(".forum-nav-browse-filter-input").attr("aria-activedescendant",t).val(s))},s.prototype.filterInputReset=function(){this.filterEnabled=!0,this.selectedTopicIndex=-1,this.selectedTopicId=null},s.prototype.keyboardBinding=function(e){var t,s,i,o=$(".forum-nav-browse-filter-input"),r=$(".forum-nav-browse-menu-item:visible"),n=r.length,a=r.eq(0).find(".forum-nav-browse-title").eq(0);switch(e.keyCode){case this.keyCodes.enter:t=r.find(".forum-nav-browse-title.is-focused"),""!==o.val()&&(t.trigger("click"),this.filterInputReset());break;case this.keyCodes.escape:this.toggleBrowseMenu(e),$(".forum-nav-browse-filter-input").val(""),this.filterInputReset(),$(".all-topics").trigger("click");break;case this.keyCodes.up:this.selectedTopicIndex>0&&(this.selectedTopicIndex-=1,this.isBrowseMenuVisible()&&(s=$(".forum-nav-browse-menu-item:visible").eq(this.selectedTopicIndex).find(".forum-nav-browse-title").eq(0),this.filterEnabled=!1,a.removeClass("is-focused"),s.addClass("is-focused")),this.selectOption(s));break;case this.keyCodes.down:this.selectedTopicIndex<n-1&&(this.selectedTopicIndex+=1,this.isBrowseMenuVisible()&&(i=$(".forum-nav-browse-menu-item:visible").eq(this.selectedTopicIndex).find(".forum-nav-browse-title").eq(0),this.filterEnabled=!1,a.removeClass("is-focused"),i.addClass("is-focused")),this.selectOption(i))}return!0},s.prototype.filterTopics=function(){var e,t,s,i=this;return t=this.$(".forum-nav-browse-filter-input").val(),e=this.$(".forum-nav-browse-menu-item"),0===t.length?(e.find(".forum-nav-browse-title.is-focused").removeClass("is-focused"),e.show()):(this.filterEnabled&&(e.hide(),s=e.each(function(e,o){var r,n,a=$(o);return!a.is(":visible")&&(n=i.getPathText(a).toLowerCase(),t.split(" ").every(function(e){return-1!==n.search(e.toLowerCase())}))?(r=a.parents(".forum-nav-browse-menu-item").andSelf(),r.add(a.find(".forum-nav-browse-menu-item")).show()):s})),s)},s.prototype.selectTopicHandler=function(e){return e.preventDefault(),this.selectTopic($(e.target))},s.prototype.selectTopic=function(e){var t,s,i;return this.hideBrowseMenu(),i=e.closest(".forum-nav-browse-menu-item"),this.trigger("topic:selected",this.getBreadcrumbText(i)),i.hasClass("forum-nav-browse-menu-all")?(this.discussionIds="",this.$(".forum-nav-filter-cohort").show(),this.retrieveAllThreads()):i.hasClass("forum-nav-browse-menu-following")?(this.retrieveFollowed(),this.$(".forum-nav-filter-cohort").hide()):(t=i.find(".forum-nav-browse-menu-item").andSelf(),s=t.filter("[data-discussion-id]").map(function(e,t){return $(t).data("discussion-id")}).get(),this.retrieveDiscussions(s),this.$(".forum-nav-filter-cohort").toggle(i.data("cohorted")===!0))},s.prototype.chooseFilter=function(){return this.filter=$(".forum-nav-filter-main-control :selected").val(),this.retrieveFirstPage()},s.prototype.chooseCohort=function(){return this.group_id=this.$(".forum-nav-filter-cohort-control :selected").val(),this.retrieveFirstPage()},s.prototype.retrieveDiscussion=function(e,t){var s,i=this;return s=DiscussionUtil.urlFor("retrieve_discussion",e),DiscussionUtil.safeAjax({url:s,type:"GET",success:function(e){i.collection.current_page=e.page,i.collection.pages=e.num_pages,i.collection.reset(e.discussion_data),Content.loadContentInfos(e.annotated_content_info),i.displayedCollection.reset(i.collection.models),t&&t()}})},s.prototype.retrieveDiscussions=function(e){return this.discussionIds=e.join(","),this.mode="commentables",this.retrieveFirstPage()},s.prototype.retrieveAllThreads=function(){return this.mode="all",this.retrieveFirstPage()},s.prototype.retrieveFirstPage=function(e){return this.collection.current_page=0,this.collection.reset(),this.loadMorePages(e)},s.prototype.sortThreads=function(e){return this.displayedCollection.setSortComparator(this.$(".forum-nav-sort-control").val()),this.retrieveFirstPage(e)},s.prototype.performSearch=function(e){this.hideBrowseMenu(),this.trigger("search:initiated"),this.searchFor(e.val(),e)},s.prototype.searchFor=function(e,t){var s,i=this;return this.clearSearchAlerts(),this.clearFilters(),this.mode="search",this.current_search=e,s=DiscussionUtil.urlFor("search"),DiscussionUtil.safeAjax({$elem:t,data:{text:e},url:s,type:"GET",dataType:"json",$loading:$,loadingCallback:function(){var e=i.$(".forum-nav-thread-list");e.empty(),edx.HtmlUtils.append(e,edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<li class='forum-nav-load-more'>"),i.getLoadingContent(gettext("Loading thread list")),edx.HtmlUtils.HTML("</li>")))},loadedCallback:function(){return i.$(".forum-nav-thread-list .forum-nav-load-more").remove()},success:function(t,s){var o,r;return"success"===s&&(i.collection.reset(t.discussion_data),Content.loadContentInfos(t.annotated_content_info),i.collection.current_page=t.page,i.collection.pages=t.num_pages,_.isNull(t.corrected_text)?0===t.discussion_data.length&&i.addSearchAlert(gettext("No threads matched your query.")):(r=_.escape(gettext("No results found for {original_query}. Showing results for {suggested_query}.")),o=edx.HtmlUtils.interpolateHtml(r,{original_query:edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<em>"),e,edx.HtmlUtils.HTML("</em>")),suggested_query:edx.HtmlUtils.joinHtml(edx.HtmlUtils.HTML("<em>"),t.corrected_text,edx.HtmlUtils.HTML("</em>"))}),i.addSearchAlert(o)),i.displayedCollection.reset(i.collection.models),e)?i.searchForUser(e):void 0}})},s.prototype.searchForUser=function(e){var t=this;return DiscussionUtil.safeAjax({data:{username:e},url:DiscussionUtil.urlFor("users"),type:"GET",dataType:"json",error:function(){},success:function(e){var s,i;return e.users.length>0?(i=edx.HtmlUtils.joinHtml(edx.HtmlUtils.interpolateHtml(edx.HtmlUtils.HTML('<a class="link-jump" href="{url}">'),{url:DiscussionUtil.urlFor("user_profile",e.users[0].id)}),e.users[0].username,edx.HtmlUtils.HTML("</a>")),s=edx.HtmlUtils.interpolateHtml(gettext("Show posts by {username}."),{username:i}),t.addSearchAlert(s,"search-by-user")):void 0}})},s.prototype.clearFilters=function(){return this.$(".forum-nav-filter-main-control").val("all"),this.$(".forum-nav-filter-cohort-control").val("all")},s.prototype.retrieveFollowed=function(){return this.mode="followed",this.retrieveFirstPage()},s.prototype.updateEmailNotifications=function(){var e,t,s;e=$("input.email-setting"),t=e.prop("checked"),s=t?"enable_notifications":"disable_notifications",DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor(s),type:"POST",error:function(){e.prop("checked",!t)}})},s}.call(this,Backbone.View))}.call(window),RequireJS.define("common/js/discussion/views/discussion_thread_list_view",function(){}),function(){var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var o in s)e.call(s,o)&&(t[o]=s[o]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadView=function(e){function s(){var e=this;return this._delete=function(){return s.prototype._delete.apply(e,arguments)},this.closeEditView=function(){return s.prototype.closeEditView.apply(e,arguments)},this.edit=function(){return s.prototype.edit.apply(e,arguments)},this.endorseThread=function(){return s.prototype.endorseThread.apply(e,arguments)},this.addComment=function(){return s.prototype.addComment.apply(e,arguments)},this.renderAddResponseButton=function(){return s.prototype.renderAddResponseButton.apply(e,arguments)},this.renderResponseToList=function(){return s.prototype.renderResponseToList.apply(e,arguments)},this.renderResponseCountAndPagination=function(){return s.prototype.renderResponseCountAndPagination.apply(e,arguments)},s.__super__.constructor.apply(this,arguments)}var i,o;return t(s,e),i=25,o=100,s.prototype.events={"click .discussion-submit-post":"submitComment","click .add-response-btn":"scrollToAddResponse","click .forum-thread-expand":"expand","click .forum-thread-collapse":"collapse"},s.prototype.$=function(e){return this.$el.find(e)},s.prototype.isQuestion=function(){return"question"===this.model.get("thread_type")},s.prototype.initialize=function(e){var t,i=this;if(s.__super__.initialize.call(this),this.mode=e.mode||"inline",this.context=e.context||"course",this.options=_.extend({},e),"tab"!==(t=this.mode)&&"inline"!==t)throw new Error("invalid mode: "+this.mode);this.readOnly=$(".discussion-module").data("read-only"),this.model.collection.on("reset",function(e){var t;t=i.model.get("id"),e.get(t)&&(i.model=e.get(t))}),this.createShowView(),this.responses=new Comments,this.loadedResponses=!1,this.isQuestion()&&(this.markedAnswers=new Comments)},s.prototype.rerender=function(){return this.showView&&this.showView.undelegateEvents(),this.undelegateEvents(),this.$el.empty(),this.initialize({mode:this.mode,model:this.model,el:this.el,course_settings:this.options.course_settings,topicId:this.topicId}),this.render()},s.prototype.renderTemplate=function(){var e,t;return this.template=_.template($("#thread-template").html()),e=$("#discussion-container"),e.length||(e=$(".discussion-module")),t=_.extend(this.model.toJSON(),{readOnly:this.readOnly,can_create_comment:e.data("user-create-comment")}),this.template(t)},s.prototype.render=function(){var e=this,t=$(this.renderTemplate());
return this.$el.empty(),this.$el.append(t),this.delegateEvents(),this.renderShowView(),this.renderAttrs(),this.$("span.timeago").timeago(),this.makeWmdEditor("reply-body"),this.renderAddResponseButton(),this.responses.on("add",function(t){return e.renderResponseToList(t,".js-response-list",{})}),this.isQuestion()&&this.markedAnswers.on("add",function(t){return e.renderResponseToList(t,".js-marked-answer-list",{collapseComments:!0})}),"tab"===this.mode?(setTimeout(function(){return e.loadInitialResponses()},100),this.$(".post-tools").hide()):this.collapse()},s.prototype.attrRenderer=$.extend({},DiscussionContentView.prototype.attrRenderer,{closed:function(e){return this.$(".discussion-reply-new").toggle(!e),this.$(".comment-form").closest("li").toggle(!e),this.$(".action-vote").toggle(!e),this.$(".display-vote").toggle(e),this.renderAddResponseButton()}}),s.prototype.expand=function(e){return e&&e.preventDefault(),this.$el.addClass("expanded"),this.$el.find(".post-body").text(this.model.get("body")),this.showView.convertMath(),this.$el.find(".forum-thread-expand").hide(),this.$el.find(".forum-thread-collapse").show(),this.$el.find(".post-extended-content").show(),this.loadedResponses?void 0:this.loadInitialResponses()},s.prototype.collapse=function(e){return e&&e.preventDefault(),this.$el.removeClass("expanded"),this.$el.find(".post-body").text(this.getAbbreviatedBody()),this.showView.convertMath(),this.$el.find(".forum-thread-expand").show(),this.$el.find(".forum-thread-collapse").hide(),this.$el.find(".post-extended-content").hide()},s.prototype.getAbbreviatedBody=function(){var e,t;return t=this.model.get("abbreviatedBody"),t?t:(e=DiscussionUtil.abbreviateString(this.model.get("body"),140),this.model.set("abbreviatedBody",e),e)},s.prototype.cleanup=function(){return this.responsesRequest&&this.responsesRequest.abort?this.responsesRequest.abort():void 0},s.prototype.loadResponses=function(e,t,s){var i,o=this;i="tab"===this.mode?!1:!0,this.responsesRequest=DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("retrieve_single_thread",this.model.get("commentable_id"),this.model.id),data:{resp_skip:this.responses.size(),resp_limit:e?e:void 0},$elem:t,$loading:t,takeFocus:i,complete:function(){o.responsesRequest=null},success:function(e){return Content.loadContentInfos(e.annotated_content_info),o.isQuestion()&&o.markedAnswers.add(e.content.endorsed_responses),o.responses.add(o.isQuestion()?e.content.non_endorsed_responses:e.content.children),o.renderResponseCountAndPagination(o.isQuestion()?e.content.non_endorsed_resp_total:e.content.resp_total),o.trigger("thread:responses:rendered"),o.loadedResponses=!0,o.$el.find('.discussion-article[data-id="'+o.model.id+'"]').focus()},error:function(e,t){"abort"!==t&&(404===e.status?DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("The thread you selected has been deleted. Please select another thread.")):s?DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading responses. Please reload the page.")):DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more responses. Please try again.")))}})},s.prototype.loadInitialResponses=function(){return this.loadResponses(i,this.$el.find(".js-response-list"),!0)},s.prototype.renderResponseCountAndPagination=function(e){var t,s,i,r,n,a,d,l=this;return i=this.isQuestion()&&0!==this.markedAnswers.length?ngettext("{numResponses} other response","{numResponses} other responses",e):ngettext("{numResponses} response","{numResponses} responses",e),this.$el.find(".response-count").text(edx.StringUtils.interpolate(i,{numResponses:e},!0)),n=this.$el.find(".response-pagination"),n.empty(),e>0&&(a=e-this.responses.size(),d=0===a?gettext("Showing all responses"):edx.StringUtils.interpolate(ngettext("Showing first response","Showing first {numResponses} responses",this.responses.size()),{numResponses:this.responses.size()},!0),n.append($("<span>").addClass("response-display-count").text(d)),a>0)?(o>a?(r=null,t=gettext("Load all responses")):(r=o,t=edx.StringUtils.interpolate(gettext("Load next {numResponses} responses"),{numResponses:r},!0)),s=$("<button>").addClass("btn-neutral").addClass("load-response-button").text(t),s.click(function(){return l.loadResponses(r,s)}),n.append(s)):void 0},s.prototype.renderResponseToList=function(e,t,s){var i;return e.set("thread",this.model),i=new ThreadResponseView($.extend({model:e},s)),i.on("comment:add",this.addComment),i.on("comment:endorse",this.endorseThread),i.render(),this.$el.find(t).append(i.el),i.afterInsert()},s.prototype.renderAddResponseButton=function(){return this.model.hasResponses()&&this.model.can("can_reply")&&!this.model.get("closed")?this.$el.find("div.add-response").show():this.$el.find("div.add-response").hide()},s.prototype.scrollToAddResponse=function(e){var t;return e.preventDefault(),t=$(e.target).parents("article.discussion-article").find("form.discussion-reply-new"),$("html, body").scrollTop(t.offset().top),t.find(".wmd-panel textarea").focus()},s.prototype.addComment=function(){return this.model.comment()},s.prototype.endorseThread=function(){return this.model.set("endorsed",this.$el.find(".action-answer.is-checked").length>0)},s.prototype.submitComment=function(e){var t,s,i;return e.preventDefault(),i=this.model.urlFor("reply"),t=this.getWmdContent("reply-body"),t.trim().length?(this.setWmdContent("reply-body",""),s=new Comment({body:t,created_at:(new Date).toISOString(),username:window.user.get("username"),votes:{up_count:0},abuse_flaggers:[],endorsed:!1,user_id:window.user.get("id")}),s.set("thread",this.model.get("thread")),this.renderResponseToList(s,".js-response-list"),this.model.addComment(),this.renderAddResponseButton(),DiscussionUtil.safeAjax({$elem:$(e.target),url:i,type:"POST",dataType:"json",data:{body:t},success:function(e){return s.updateInfo(e.annotated_content_info),s.set(e.content)}})):void 0},s.prototype.edit=function(){return this.createEditView(),this.renderEditView()},s.prototype.createEditView=function(){return this.showView&&(this.showView.undelegateEvents(),this.showView.$el.empty(),this.showView=null),this.editView=new DiscussionThreadEditView({container:this.$(".thread-content-wrapper"),model:this.model,mode:this.mode,context:this.context,course_settings:this.options.course_settings}),this.editView.bind("thread:updated thread:cancel_edit",this.closeEditView),this.editView.bind("comment:endorse",this.endorseThread)},s.prototype.renderSubView=function(e){return e.setElement(this.$(".thread-content-wrapper")),e.render(),e.delegateEvents()},s.prototype.renderEditView=function(){return this.editView.render()},s.prototype.createShowView=function(){return this.showView=new DiscussionThreadShowView({model:this.model,mode:this.mode}),this.showView.bind("thread:_delete",this._delete),this.showView.bind("thread:edit",this.edit)},s.prototype.renderShowView=function(){return this.renderSubView(this.showView)},s.prototype.closeEditView=function(){return this.createShowView(),this.renderShowView(),this.renderAttrs(),this.$el.find(".post-extended-content").show()},s.prototype._delete=function(e){var t,s;return s=this.model.urlFor("_delete"),this.model.can("can_delete")&&confirm(gettext("Are you sure you want to delete this post?"))?(this.model.remove(),this.showView.undelegateEvents(),this.undelegateEvents(),this.$el.empty(),t=$(e.target),DiscussionUtil.safeAjax({$elem:t,url:s,type:"POST"})):void 0},s}(DiscussionContentView))}.call(window),RequireJS.define("common/js/discussion/views/discussion_thread_view",function(){}),function(){RequireJS.define("discussion/js/discussion_router",["underscore","backbone","common/js/discussion/utils","common/js/discussion/views/discussion_thread_list_view","common/js/discussion/views/discussion_thread_view"],function(e,t,s,i,o){var r=t.Router.extend({routes:{"":"allThreads",":forum_name/threads/:thread_id":"showThread"},initialize:function(s){t.Router.prototype.initialize.call(this),e.bindAll(this,"allThreads","showThread"),this.courseId=s.courseId,this.discussion=s.discussion,this.course_settings=s.courseSettings,this.newPostView=s.newPostView,this.nav=new i({collection:this.discussion,el:$(".forum-nav"),courseSettings:this.course_settings}),this.nav.render()},start:function(){var i=this,o=$(".new-post-btn");this.listenTo(this.newPostView,"newPost:cancel",this.hideNewPost),o.bind("click",e.bind(this.showNewPost,this)),o.bind("keydown",function(e){s.activateOnSpace(e,i.showNewPost)}),this.nav.on("thread:selected",e.bind(this.navigateToThread,this)),this.nav.on("thread:removed",e.bind(this.navigateToAllThreads,this)),this.nav.on("threads:rendered",e.bind(this.setActiveThread,this)),this.nav.on("thread:created",e.bind(this.navigateToThread,this)),t.history.start({pushState:!0,root:"/courses/"+this.courseId+"/discussion/forum/"})},stop:function(){t.history.stop()},allThreads:function(){return this.nav.updateSidebar(),this.nav.goHome()},setActiveThread:function(){return this.thread?this.nav.setActiveThread(this.thread.get("id")):this.nav.goHome},showThread:function(e,t){return this.thread=this.discussion.get(t),this.thread.set("unread_comments_count",0),this.thread.set("read",!0),this.setActiveThread(),this.showMain()},showMain:function(){var e=this;return this.main&&(this.main.cleanup(),this.main.undelegateEvents()),$(".forum-content").is(":visible")||$(".forum-content").fadeIn(),this.newPostView.$el.is(":visible")&&this.newPostView.$el.fadeOut(),this.main=new o({el:$(".forum-content"),model:this.thread,mode:"tab",course_settings:this.course_settings}),this.main.render(),this.main.on("thread:responses:rendered",function(){return e.nav.updateSidebar()}),this.thread.on("thread:thread_type_updated",this.showMain)},navigateToThread:function(e){var t;return t=this.discussion.get(e),this.navigate(""+t.get("commentable_id")+"/threads/"+e,{trigger:!0})},navigateToAllThreads:function(){return this.navigate("",{trigger:!0})},showNewPost:function(){var e=this;return $(".forum-content").fadeOut({duration:200,complete:function(){return e.newPostView.$el.fadeIn(200).focus()}})},hideNewPost:function(){return this.newPostView.$el.fadeOut({duration:200,complete:function(){return $(".forum-content").fadeIn(200).find(".thread-wrapper").focus()}})}});return r})}.call(this,define||RequireJS.define),RequireJS.define("text",{load:function(e){throw new Error("Dynamic load not allowed: "+e)}}),RequireJS.define("text!discussion/templates/fake-breadcrumbs.underscore",[],function(){return'<h6 class="hd-6 breadcrumbs">\n    <span class="nav-item">\n        <button class="btn-link all-topics">\n            <span class="icon fa fa-bars" aria-hidden="true"></span><%- gettext(\'All Topics\') %>\n        </button>\n    </span>\n    <% contents.forEach(function(content) { %>\n        <span class="fa fa-angle-right"></span>\n        <span class="nav-item"><%- content %></span>\n    <% }); %>\n</h6>\n'}),function(){RequireJS.define("discussion/js/views/discussion_fake_breadcrumbs",["backbone","gettext","edx-ui-toolkit/js/utils/html-utils","text!discussion/templates/fake-breadcrumbs.underscore"],function(e,t,s,i){var o=e.View.extend({initialize:function(){this.template=s.template(i),this.listenTo(this.model,"change",this.render),this.render()},render:function(){var e=this.model.attributes;return s.setHtml(this.$el,this.template(e)),this}});return o})}.call(this,define||RequireJS.define),function(){RequireJS.define("edx-ui-toolkit/js/utils/constants",[],function(){return{keyCodes:{tab:9,enter:13,esc:27,space:32,left:37,up:38,right:39,down:40}}})}.call(this,"function"==typeof RequireJS.define&&RequireJS.define.amd?RequireJS.define:"undefined"!=typeof RequireJS?RequireJS.define:edx.GlobalLoader.defineAs("constants","edx-ui-toolkit/js/utils/constants")),RequireJS.define("text!discussion/templates/search.underscore",[],function(){return'<label class="field-label sr-only" for="search" id="search-hint"><%- gettext("Search all posts") %></label>\n<input\n    class="field-input input-text search-input"\n    type="search"\n    name="search"\n    id="search"\n    placeholder="<%- gettext("Search all posts") %>"\n/>\n<button class="btn-brand btn-small search-btn" type="button"><%- gettext("Search") %></button>\n'}),function(){RequireJS.define("discussion/js/views/discussion_search_view",["underscore","backbone","edx-ui-toolkit/js/utils/html-utils","edx-ui-toolkit/js/utils/constants","text!discussion/templates/search.underscore"],function(e,t,s,i,o){var r=t.View.extend({events:{"keydown .search-input":"performSearch","click .search-btn":"performSearch","topic:selected":"clearSearch"},initialize:function(t){e.extend(this,e.pick(t,"threadListView")),this.template=s.template(o),this.threadListView=t.threadListView,this.listenTo(this.model,"change",this.render),this.render()},render:function(){return s.setHtml(this.$el,this.template()),this},performSearch:function(e){(e.which===i.keyCodes.enter||"click"===e.type)&&(e.preventDefault(),this.threadListView.performSearch($(".search-input",this.$el)))},clearSearch:function(){this.$(".search-input").val(""),this.threadListView.clearSearchAlerts()}});return r})}.call(this,define||RequireJS.define),function(){var e={}.hasOwnProperty,t=function(t,s){function i(){this.constructor=t}for(var o in s)e.call(s,o)&&(t[o]=s[o]);return i.prototype=s.prototype,t.prototype=new i,t.__super__=s.prototype,t};"undefined"!=typeof Backbone&&null!==Backbone&&(this.NewPostView=function(e){function s(){var e=this;return this.updateStyles=function(){return s.prototype.updateStyles.apply(e,arguments)},this.resetForm=function(){return s.prototype.resetForm.apply(e,arguments)},s.__super__.constructor.apply(this,arguments)}return t(s,e),s.prototype.initialize=function(e){var t;if(this.mode=e.mode||"inline","tab"!==(t=this.mode)&&"inline"!==t)throw new Error("invalid mode: "+this.mode);this.course_settings=e.course_settings,this.is_commentable_cohorted=e.is_commentable_cohorted,this.topicId=e.topicId},s.prototype.render=function(){var e,t;return e=_.clone(this.course_settings.attributes),_.extend(e,{cohort_options:this.getCohortOptions(),is_commentable_cohorted:this.is_commentable_cohorted,mode:this.mode,form_id:this.mode+(this.topicId?"-"+this.topicId:"")}),this.$el.html(_.template($("#new-post-template").html())(e)),t=_.template($("#thread-type-template").html()),$(".js-group-select").prop("disabled")&&$(".group-selector-wrapper").addClass("disabled"),this.addField(t({form_id:_.uniqueId("form-")})),this.isTabMode()&&(this.topicView=new DiscussionTopicMenuView({topicId:this.topicId,course_settings:this.course_settings}),this.topicView.on("thread:topic_change",this.toggleGroupDropdown),this.addField(this.topicView.render())),DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"js-post-body")},s.prototype.addField=function(e){return this.$(".forum-new-post-form-wrapper").append(e)},s.prototype.isTabMode=function(){return"tab"===this.mode},s.prototype.getCohortOptions=function(){var e;return this.course_settings.get("is_cohorted")&&DiscussionUtil.isPrivilegedUser()?(e=$("#discussion-container").data("user-cohort-id"),_.map(this.course_settings.get("cohorts"),function(t){return{value:t.id,text:t.name,selected:t.id===e}})):null},s.prototype.events={"submit .forum-new-post-form":"createPost","change .post-option-input":"postOptionChange","click .cancel":"cancel","reset .forum-new-post-form":"updateStyles"},s.prototype.toggleGroupDropdown=function(e){return e.data("cohorted")?($(".js-group-select").prop("disabled",!1),$(".group-selector-wrapper").removeClass("disabled")):($(".js-group-select").val("").prop("disabled",!0),$(".group-selector-wrapper").addClass("disabled"))},s.prototype.postOptionChange=function(e){var t,s;return s=$(e.target),t=s.closest(".post-option"),s.is(":checked")?t.addClass("is-enabled"):t.removeClass("is-enabled")},s.prototype.createPost=function(e){var t,s,i,o,r,n,a,d,l,u=this;return e.preventDefault(),n=this.$(".post-type-input:checked").val(),a=this.$(".js-post-title").val(),i=this.$(".js-post-body").find(".wmd-input").val(),r=this.$(".js-group-select option:selected").attr("value"),t=!1||this.$(".js-anon").is(":checked"),s=!1||this.$(".js-anon-peers").is(":checked"),o=!1||this.$(".js-follow").is(":checked"),d=this.isTabMode()?this.topicView.getCurrentTopicId():this.topicId,l=DiscussionUtil.urlFor("create_thread",d),DiscussionUtil.safeAjax({$elem:$(e.target),$loading:e?$(e.target):void 0,url:l,type:"POST",dataType:"json",data:{thread_type:n,title:a,body:i,anonymous:t,anonymous_to_peers:s,auto_subscribe:o,group_id:r},error:DiscussionUtil.formErrorHandler(this.$(".post-errors")),success:function(e){var t;return t=new Thread(e.content),u.$el.hide(),u.resetForm(),u.collection.add(t)}})},s.prototype.cancel=function(e){return e.preventDefault(),confirm(gettext("Your post will be discarded."))?(this.trigger("newPost:cancel"),this.resetForm()):void 0},s.prototype.resetForm=function(){return this.$(".forum-new-post-form")[0].reset(),DiscussionUtil.clearFormErrors(this.$(".post-errors")),this.$(".wmd-preview p").html(""),this.isTabMode()?this.topicView.setTopic(this.$("button.topic-title").first()):void 0},s.prototype.updateStyles=function(){var e=this;return setTimeout(function(){return e.$(".post-option-input").trigger("change")},1)},s}(Backbone.View))}.call(window),RequireJS.define("common/js/discussion/views/new_post_view",function(){}),function(){RequireJS.define("discussion/js/discussion_board_factory",["jquery","backbone","discussion/js/discussion_router","discussion/js/views/discussion_fake_breadcrumbs","discussion/js/views/discussion_search_view","common/js/discussion/views/new_post_view"],function(e,t,s,i,o,r){return function(n){var a,d,l,u,c,h,p,m,f=n.user_info,g=n.sort_preference,v=n.threads,w=n.thread_pages,y=n.content_info,$=new window.DiscussionUser(f);window.DiscussionUtil.loadRoles(n.roles),window.$$course_id=n.courseId,window.courseName=n.course_name,window.DiscussionUtil.setUser($),window.user=$,window.Content.loadContentInfos(y),a=new window.Discussion(v,{pages:w,sort:g}),d=new window.DiscussionCourseSettings(n.course_settings),l=new r({el:e(".new-post-article"),collection:a,course_settings:d,mode:"tab"}),l.render(),u=new s({courseId:n.courseId,discussion:a,courseSettings:d,newPostView:l}),u.start(),p=new o({el:e(".forum-search"),threadListView:u.nav}).render(),h=t.Model.extend({defaults:{contents:[]}}),c=new i({el:e(".has-breadcrumbs"),model:new h,events:{"click .all-topics":function(e){e.preventDefault(),p.clearSearch(),this.model.set("contents",[]),u.navigate("",{trigger:!0}),u.nav.toggleBrowseMenu(e)}}}).render(),m={"topic:selected":function(e){c.model.set("contents",e)},"thread:selected":function(){p.clearSearch()},"search:initiated":function(){c.model.set("contents",["Search Results"])}},Object.keys(m).forEach(function(e){u.nav.on(e,m[e])})}})}.call(this,define||RequireJS.define);